---
title: "Pronósticos de indicadores clave de construcción y vivienda"
author: "Claudio Daniel Pacheco Castro"
date: "3/8/2020"
pagetitle: "Prospectiva CANADEVI"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```
# Introducción
El presente trabajo es un ejercicio de prospectiva realizado desde <b>[CANADEVI NACIONAL](https://www.canadevi.com.mx)</b> para ofrecer información oportuna que permita conocer las tendencias de los indicadores más relevantes del sector de la construcción y, en particular, el de la vivienda para la toma de decisiones.

Conforme se vayan dando a conocer los datos observados por parte de las fuentes oficiales y aquellas que sirvan como insumo para los cálculos, las estimaciones de este documento se irán actualizando.


Para tener más información sobre la coyuntura del sector, consulta nuestro <b>[Boletín Mensual](https://www.canadevi.com.mx/index.php/servicios/estadistica/canadevi-en-cifras/reporte-mensual)</b>.


# Datos
## Producto Interno Bruto de la Construcción

```{r echo=FALSE, message=FALSE}
library(tidyverse)
library(forecast)
library(scales)
library(lubridate)


##Datos
pib<-read.csv("https://raw.githubusercontent.com/claudiodanielpc/forecast/master/pibvar.csv",
             encoding="latin",header=TRUE,check.names=FALSE)%>%
  mutate(trim=seq(ymd("1994/1/1"), ymd("2020/12/30"), by = "quarter"))%>%
  mutate(trim=quarter(trim,with_year=T))

##Se crea el dataset para el modelo
pibmod<-pib%>%
  ###Se dejan los datos observados
  filter(trim<="2020.1")%>%
  ##Se transforma a serie de tiempo
  ts(.,start=c(1994,1),frequency=4)

##Se establecen el vector de regresores
xreg<-pib%>%
  ##Se dejan los datos que permitirán estimar hacia adelante
  filter(trim>"2020.1")%>%
  ##Se transforma a serie de tiempo
  ts(.,start=c(2020,2),frequency=4)



##Se crea el modelo

modelo<-auto.arima(pibmod[,"const"],
                   xreg=pibmod[,"pib"])

#Pronóstico

fcast<-forecast(modelo,xreg=xreg[,"pib"])%>%
  as.data.frame()%>%
  rename(const=1)%>%
  select(const)%>%
  mutate(trim=seq(ymd("2020/4/1"), ymd("2020/12/30"), by = "quarter"))%>%
  mutate(trim=quarter(trim,with_year=T))



estima<-pibmod%>%
  as.data.frame()%>%
  select(const,trim)%>%
  mutate(const = replace(const, trim<="2020.1", NA))
  
estima<-rbind(estima,fcast)
estima<-estima%>%
  mutate(tipo="Estimado")

##Crear la dataframe para graficarlo

datos<-pibmod%>%
  as.data.frame()%>%
  select(const,trim)%>%
  mutate(tipo="Observado")

datos<-rbind(datos,estima)

##Gráfica dinámica
library(highcharter)

#hchart(fcast) %>% hc_add_theme(hc_theme_sandsignika())
     highchart()%>%
            ##Tipo de gráfico
           ##Título
            hc_title(text = "<b>Producto Interno Bruto de la Construcción</b>",
                     margin = 20, align = "left",
                     style = list(color = "black", useHTML = TRUE))%>%
       ##Subtítulo
            hc_subtitle(text = "<i>1994-2020</i>
                        <br><i>Variación % anual</i>",
                        align = "left",
                        style = list(color = "black", fontWeight = "bold")) %>%
             ##Series
       hc_add_series(datos$const[datos$tipo=='Observado'],
                      name="Observado",
                      color='#bdbdbd', 
                     type="column",
                     pointWidth=4,
                      marker = list(symbol = 'circle'))%>%
       hc_add_series(datos$const[datos$tipo=='Estimado'],
                      name="Estimado",
                      color='#feb24c', 
                     type="column",
                     pointWidth=4,
                      marker = list(symbol = 'circle') )%>%
     
     hc_xAxis(categories =  unique(datos$trim)) %>%
            hc_yAxis( title = list(text = "Var. % anual"))%>%
       hc_credits(
    enabled = TRUE, text = "Fuente: Elaborado por CANADEVI Nacional. 
    Gerencia de Fondos de Vivienda. 
    Coordinación de Indicadores de Vivienda con información de INEGI y Banco de México.",
    style = list(fontSize = "8px")
  )
  
     
```

## Trabajadores de la construcción asegurados ante el IMSS 

```{r}

```

## Producción de vivienda

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(forecast)
library(scales)
library(lubridate)


##Se importa la base de datos de RUV
##URL del archivo
ruvurl<-"https://raw.githubusercontent.com/claudiodanielpc/vivienda/ruv/datos%20ruv.csv"
ruv<-read.csv(ruvurl,
               encoding="latin",header=TRUE,check.names=FALSE)


ruv<-ruv%>%
  ##Variable fecha
  mutate(fecha=ymd(paste(year, month, 15,sep= ' ')))%>%

##Se transforma a serie de tiempo
ts(.,start=c(2013,1),frequency=12)



modruv<-auto.arima(ruv[,"prod"])

ruvest<-forecast(modruv,6)

##Transformar a dataframe
library(ggfortify)
df<-fortify(ruvest)


##Crear highchart
library(highcharter)

highchart(type = "stock") %>% 
  ##Título
            hc_title(text = "<b>Producción de vivienda</b>",
                     margin = 20, align = "left",
                     style = list(color = "black", useHTML = TRUE))%>%
       ##Subtítulo
            hc_subtitle(text = "<i>2013-2020</i>",
                        align = "left",
                        style = list(color = "black", fontWeight = "bold")) %>%
  hc_add_series(df, "line", hcaes(Index, Data), name = "Observado",
                color='#bdbdbd') %>% 
  #hc_add_series(df, "line", hcaes(Index, Fitted), name = "Estimado",
   #             dashStyle = "shortdash",color='#feb24c') %>%
  hc_add_series(df, "line", hcaes(Index, `Point Forecast`), name = "Estimado",
                color='#feb24c',dashStyle = "shortdash") %>% 
  #hc_add_series(df, "arearange", hcaes(Index, low = `Lo 80`, high = `Hi 80`), name = "Intervalo", color="#e5f5e0")%>%
       hc_yAxis( title = list(text = "Viviendas"))%>%
       hc_credits(
    enabled = TRUE, text = "Fuente: Elaborado por CANADEVI Nacional. 
    Gerencia de Fondos de Vivienda. 
    Coordinación de Indicadores de Vivienda con información de RUV.",
    style = list(fontSize = "8px")
  )


```

